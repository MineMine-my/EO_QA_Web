<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ä¹™çƒ¯ç¯æ°§åŒ–å‚¬åŒ–å‰‚æ™ºèƒ½é—®ç­”</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf9 100%);
            display: flex;
            height: 100vh;
            overflow: hidden;
            color: #2c3e50;
        }

        /* ========== å·¦ä¾§å†å²è®°å½•é¢æ¿ ========== */
        #history-panel {
            width: 230px;
            background: white;
            padding: 20px 16px;
            border-right: 1px solid #e0e6ed;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 12px rgba(0, 0, 0, 0.06);
        }

        #history-panel h3 {
            margin-bottom: 16px;
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        #history-list {
            flex: 1;
            overflow-y: auto;
            max-height: calc(100vh - 200px);
            padding-right: 4px;
        }

        .history-item {
            padding: 8px 12px;
            margin: 6px 0;
            background: #f8fafd;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            color: #2980b9;
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
            word-break: break-word;
        }

        .history-item:hover {
            background: #edf5ff;
            border-left-color: #3498db;
            transform: translateX(2px);
        }

        .history-item + .history-item {
            margin-top: 6px;
        }

        #clear-history {
            margin-top: 16px;
            padding: 8px 12px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.2s;
        }

        #clear-history:hover {
            background: #c0392b;
        }

        #back-home {
            width: 100%;
            padding: 10px 12px;
            margin-bottom: 30px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
            transition: background 0.2s, transform 0.15s;
        }

        #back-home:hover {
            background: #2980b9;
            transform: translateY(-1px);
        }

        /* æ»šåŠ¨æ¡ç¾åŒ– - éšè—æ»šåŠ¨æ¡ */
        #history-list::-webkit-scrollbar {
            width: 0px;
        }
        #history-list::-webkit-scrollbar-thumb {
            background: transparent;
        }
        #history-list::-webkit-scrollbar-thumb:hover {
            background: transparent;
        }
        
        /* ========== å³ä¾§é—®ç­”ä¸»åŒº ========== */
        #main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 24px;
            position: relative;
        }

        /* èŠå¤©å®¹å™¨ï¼šç•™å‡ºè¾“å…¥æ¡†ç©ºé—´ */
        #chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            display: flex;
            flex-direction: column;
            min-height: 0;
            margin-bottom: 80px; /* ç•™å‡ºè¾“å…¥æ¡†+ç©ºç™½åŒºåŸŸçš„ç©ºé—´ */
        }

        .message {
            max-width: 75%;
            padding: 14px 18px;
            margin: 12px 0;
            border-radius: 18px;
            line-height: 1.55;
            word-break: break-word;
            font-size: 14px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .user-message {
            align-self: flex-end;
            background: linear-gradient(to right, #3498db, #2980b9);
            color: white;
            border-bottom-right-radius: 6px;
        }

        .bot-message {
            align-self: flex-start;
            background: #f9fbfd;
            color: #2c3e50;
            border: 1px solid #eaeef5;
            border-bottom-left-radius: 6px;
        }

        /* è¾“å…¥åŒºåŸŸï¼šå›ºå®šåœ¨åº•éƒ¨ */
        #input-wrapper {
            position: absolute;
            bottom: 24px; /* è·ç¦»åº•éƒ¨ç•™ç™½ */
            left: 50%;
            transform: translateX(-50%);
            width: 85%;
            max-width: 620px;
            display: flex;
            gap: 12px;
        }

        #question-input {
            flex: 1;
            padding: 14px 20px;
            border: 2px solid #dde5f0;
            border-radius: 30px;
            font-size: 15px;
            outline: none;
            background: #fff;
            transition: border-color 0.3s;
        }

        #question-input:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.15);
        }

        #send-btn {
            padding: 14px 24px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            font-weight: 600;
            font-size: 15px;
            transition: background 0.2s, transform 0.15s;
        }

        #send-btn:hover {
            background: #2980b9;
            transform: translateY(-1px);
        }

        #send-btn:active {
            transform: translateY(0);
        }
        
        /* è¿½é—®æŒ‰é’®æ ·å¼ - å·²ç§»é™¤ */
        .follow-up-btn {
            display: none; /* éšè—è¿½é—®æŒ‰é’® */
        }
        
        .context-buttons {
            display: none; /* éšè—è¿½é—®æŒ‰é’®å®¹å™¨ */
        }
        
        /* éšè—å³ä¾§æ»šåŠ¨æ¡ */
        #chat-container::-webkit-scrollbar {
            width: 0px;
        }
        #chat-container::-webkit-scrollbar-thumb {
            background: transparent;
        }
        #chat-container::-webkit-scrollbar-thumb:hover {
            background: transparent;
        }
        
        /* âœ… ä¿®æ”¹åçš„é«˜äº®åŠ¨ç”»ï¼šæµ…è“è‰²èƒŒæ™¯ï¼Œæ— ç´«è‰²è¾¹æ¡† */
        .highlight-animation {
            animation: highlightPulse 2s ease-in-out;
        }

        @keyframes highlightPulse {
            0% { 
                background-color: #f0f6ffff; /* æµ…è“è‰² */
                box-shadow: 0 0 0 rgba(0, 0, 0, 0); /* æ— è¾¹æ¡†/é˜´å½± */
            }
            50% { 
                background-color: #e4f0fcff; /* æ›´æ˜æ˜¾çš„æµ…è“ */
                box-shadow: 0 0 0 rgba(0, 0, 0, 0);
            }
            100% { 
                background-color: inherit; 
                box-shadow: none; 
            }
        }
    </style>
</head>
<body>
    <!-- å·¦ä¾§ï¼šå†å²è®°å½• -->
    <div id="history-panel">
        <button id="back-home" onclick="window.location.href='/'">
            ğŸ  è¿”å›ä¸»é¡µ
        </button>
        <h3>ğŸ’¬ é—®ç­”å†å²</h3>
        <div id="history-list"></div>
        <button id="clear-history" onclick="clearHistory()">æ¸…ç©ºå†å²</button>
    </div>

    <!-- å³ä¾§ï¼šAIé—®ç­”ç•Œé¢ -->
    <div id="main-content">
        <div id="chat-container"></div>
        <div id="input-wrapper">
            <input type="text" id="question-input" placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜ï¼ˆä¾‹å¦‚ï¼šAg å‚¬åŒ–å‰‚çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿï¼‰" />
            <button id="send-btn" onclick="askQuestion()">å‘é€</button>
        </div>
    </div>

    <script>
        // ========== å¤ç”¨å†å²åŠŸèƒ½ ========== 
        const HISTORY_KEY = 'kg_question_history';
        let historySet = new Set();
        let conversationHistory = []; // å­˜å‚¨å®Œæ•´çš„å¯¹è¯å†å²

        // åˆå§‹åŒ–å†å²è®°å½•
        function initHistory() {
            const saved = localStorage.getItem(HISTORY_KEY);
            if (saved) {
                try {
                    const list = JSON.parse(saved);
                    list.forEach(item => {
                        historySet.add(item);
                        conversationHistory.push({
                            id: Date.now() + Math.random(),
                            question: item,
                            timestamp: new Date().toISOString()
                        });
                    });
                } catch (e) {
                    console.warn('å†å²è®°å½•è§£æå¤±è´¥', e);
                }
            }
            renderHistory();
        }

        // æ¸²æŸ“å†å²åˆ—è¡¨åˆ° DOM
        function renderHistory() {
            const container = document.getElementById('history-list');
            container.innerHTML = '';
            const historyArray = [...historySet].reverse();
            
            historyArray.forEach((term, index) => {
                const div = document.createElement('div');
                div.className = 'history-item';
                div.textContent = term;
                div.title = `ç‚¹å‡»è·³è½¬åˆ° "${term}" çš„å¯¹è¯`;
                
                const historyItem = conversationHistory.find(item => item.question === term);
                
                if (historyItem) {
                    div.onclick = () => scrollToConversation(historyItem.id, term);
                }
                
                container.appendChild(div);
            });
        }

        // æ·»åŠ æœç´¢è¯åˆ°å†å²
        function addToHistory(term) {
            if (!term.trim()) return;
            
            const historyItem = {
                id: Date.now() + Math.random(),
                question: term,
                timestamp: new Date().toISOString()
            };
            
            historySet.delete(term);
            historySet.add(term);
            conversationHistory.push(historyItem);
            
            if (historySet.size > 20) {
                const first = historySet.values().next().value;
                historySet.delete(first);
                conversationHistory = conversationHistory.filter(item => item.question !== first);
            }
            
            localStorage.setItem(HISTORY_KEY, JSON.stringify([...historySet]));
            renderHistory();
        }

        // æ¸…ç©ºå†å²
        function clearHistory() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰é—®ç­”å†å²å—ï¼Ÿ')) {
                historySet.clear();
                conversationHistory = [];
                localStorage.removeItem(HISTORY_KEY);
                renderHistory();
                document.getElementById('chat-container').innerHTML = '';
            }
        }

        // ========== é—®ç­”é€»è¾‘ ========== 
        const questionInput = document.getElementById('question-input');
        const chatContainer = document.getElementById('chat-container');

        questionInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                askQuestion();
            }
        });

        function askQuestion() {
            const question = questionInput.value.trim();
            if (!question) return;

            // åˆ›å»ºç”¨æˆ·æ¶ˆæ¯
            const userMsg = document.createElement('div');
            userMsg.className = 'message user-message';
            userMsg.textContent = question;
            userMsg.setAttribute('data-question', question);
            userMsg.setAttribute('data-id', Date.now() + Math.random());
            chatContainer.appendChild(userMsg);

            // æ¸…ç©ºè¾“å…¥æ¡†
            questionInput.value = '';

            // æ»šåŠ¨åˆ°åº•éƒ¨ï¼ˆç¡®ä¿æ–°æ¶ˆæ¯å¯è§ï¼‰
            chatContainer.scrollTop = chatContainer.scrollHeight;

            // æ˜¾ç¤ºåŠ è½½æç¤º
            const loadingMsg = document.createElement('div');
            loadingMsg.className = 'message bot-message';
            loadingMsg.textContent = 'æ­£åœ¨æ€è€ƒä¸­...';
            loadingMsg.setAttribute('data-id', 'loading-' + Date.now());
            chatContainer.appendChild(loadingMsg);
            chatContainer.scrollTop = chatContainer.scrollHeight;

            // å‘é€è¯·æ±‚åˆ°åç«¯
            const encodedQuestion = encodeURIComponent(question);
            
            fetch(`/api/ask_question?q=${encodedQuestion}`)
                .then(response => response.json())
                .then(data => {
                    // ç§»é™¤åŠ è½½æç¤º
                    const loadingElement = document.querySelector('[data-id="loading-' + loadingMsg.getAttribute('data-id').split('-')[1] + '"]');
                    if (loadingElement) {
                        chatContainer.removeChild(loadingElement);
                    }
                    
                    const botMsg = document.createElement('div');
                    botMsg.className = 'message bot-message';
                    botMsg.textContent = data.answer || 'æŠ±æ­‰ï¼Œæœªèƒ½è·å–å›ç­”';
                    botMsg.setAttribute('data-answer', data.answer || 'æŠ±æ­‰ï¼Œæœªèƒ½è·å–å›ç­”');
                    botMsg.setAttribute('data-id', Date.now() + Math.random());
                    chatContainer.appendChild(botMsg);
                    
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                    
                    addToHistory(question);
                })
                .catch(err => {
                    console.error('Error:', err);
                    const loadingElement = document.querySelector('[data-id^="loading-"]');
                    if (loadingElement && loadingElement.parentNode === chatContainer) {
                        chatContainer.removeChild(loadingElement);
                    }
                    
                    const errorMsg = document.createElement('div');
                    errorMsg.className = 'message bot-message';
                    errorMsg.textContent = 'è¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
                    errorMsg.setAttribute('data-id', Date.now() + Math.random());
                    chatContainer.appendChild(errorMsg);
                    
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                });
        }

        // æ»šåŠ¨åˆ°ç‰¹å®šå¯¹è¯ä½ç½®å¹¶é«˜äº®
        function scrollToConversation(historyId, questionText) {
            const userMessages = document.querySelectorAll('.message.user-message');
            
            for (let i = 0; i < userMessages.length; i++) {
                const msg = userMessages[i];
                if (msg.textContent === questionText) {
                    msg.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start',
                        inline: 'nearest'
                    });
                    
                    msg.classList.add('highlight-animation');
                    
                    const nextElement = msg.nextElementSibling;
                    if (nextElement && nextElement.classList.contains('bot-message')) {
                        nextElement.classList.add('highlight-animation');
                    }
                    
                    setTimeout(() => {
                        msg.classList.remove('highlight-animation');
                        if (nextElement && nextElement.classList.contains('bot-message')) {
                            nextElement.classList.remove('highlight-animation');
                        }
                    }, 2000);
                    
                    return;
                }
            }
            
            alert('æœªæ‰¾åˆ°å¯¹åº”çš„å¯¹è¯è®°å½•');
        }

        window.onload = () => {
            initHistory();
        };
    </script>
</body>
</html>


