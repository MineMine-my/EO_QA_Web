<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ä¹™çƒ¯ç¯æ°§åŒ–å‚¬åŒ–å‰‚çŸ¥è¯†å›¾è°±</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: Arial, sans-serif;
            background: #f9f9f9;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        
        /* ä¸»å†…å®¹åŒº */
        #main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }
        #search-box {
            margin-bottom: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        #graph {
            flex: 1;
            border: 1px solid #eee;
            border-radius: 8px;
            background: white;
        }
        .hint {
            color: #666;
            font-size: 0.9em;
            margin-top: 8px;
        }
        input, button {
            padding: 8px 12px;
            margin: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }
        button:hover {
            background: #f0f0f0;
            cursor: pointer;
        }
        h2 {
            margin-bottom: 10px;
        }
    </style>
    <link rel="stylesheet" href="/static/css/shared-sidebar.css">
</head>
<body>
    <!-- å·¦ä¾§å†å²è®°å½• -->
    <div id="history-panel">
        <button id="back-home" onclick="window.location.href='/'">
            ğŸ  è¿”å›ä¸»é¡µ
        </button>
        <h3>ğŸ” æœç´¢å†å²</h3>
        <div id="history-list"></div>
        <button id="clear-history" onclick="clearHistory()">æ¸…ç©ºå†å²</button>
    </div>

    <!-- ä¸»å†…å®¹åŒº -->
    <div id="main-content">
        <div id="search-box">
            <h2>ğŸ”¬ ä¹™çƒ¯ç¯æ°§åŒ–å‚¬åŒ–å‰‚çŸ¥è¯†å›¾è°±</h2>
            <input type="text" id="query" placeholder="è¾“å…¥å®ä½“åç§°ï¼Œä¾‹å¦‚ï¼šAgã€é€‰æ‹©æ€§ã€Cs..." />
            <button onclick="search()">æœç´¢</button>
            <button onclick="loadFullGraph()">æ˜¾ç¤ºå…¨å›¾</button>
            <!-- âœ… ä¿®æ”¹ï¼šå°† class="hint" æ”¹ä¸º id="hint" ä»¥ä¾¿ JS æ§åˆ¶ -->
            <p id="hint" class="hint"></p>
        </div>
        <div id="graph"></div>
    </div>

    <script>
        const chart = echarts.init(document.getElementById('graph'));
        const HISTORY_KEY = 'kg_search_history';
        let historySet = new Set(); // ç”¨ Set é¿å…é‡å¤

        // === âœ… ä¿®æ”¹ï¼šè½®æ’­æç¤ºæ–‡æœ¬ ===
        const hints = [
            'æç¤ºï¼šå¯å°è¯• Ag, ç¯æ°§ä¹™çƒ·, é€‰æ‹©æ€§, Cs, æ¸©åº¦, Alâ‚‚Oâ‚ƒ ç­‰',
            'æç¤ºï¼šåŒå‡»å›¾è°±ä¸­çš„èŠ‚ç‚¹å¯ä»¥æœç´¢è¯¥èŠ‚ç‚¹'
        ];
        let hintIndex = 0;
        const hintEl = document.getElementById('hint');

        function startHintRotation() {
            hintEl.textContent = hints[hintIndex];
            setInterval(() => {
                hintIndex = (hintIndex + 1) % hints.length;
                hintEl.textContent = hints[hintIndex];
            }, 4000);
        }

        // åˆå§‹åŒ–å†å²è®°å½•
        function initHistory() {
            const saved = localStorage.getItem(HISTORY_KEY);
            if (saved) {
                try {
                    const list = JSON.parse(saved);
                    list.forEach(item => historySet.add(item));
                } catch (e) {
                    console.warn('å†å²è®°å½•è§£æå¤±è´¥', e);
                }
            }
            renderHistory();
        }

        // æ¸²æŸ“å†å²åˆ—è¡¨åˆ° DOM
        function renderHistory() {
            const container = document.getElementById('history-list');
            container.innerHTML = '';
            const historyArray = [...historySet].reverse();
            historyArray.forEach(term => {
                const div = document.createElement('div');
                div.className = 'history-item';
                div.textContent = term;
                div.title = `ç‚¹å‡»é‡æ–°æœç´¢ "${term}"`;
                div.onclick = () => {
                    document.getElementById('query').value = term;
                    search();
                };
                container.appendChild(div);
            });
        }

        // æ·»åŠ æœç´¢è¯åˆ°å†å²
        function addToHistory(term) {
            if (!term.trim()) return;
            historySet.delete(term); // å…ˆåˆ é™¤ï¼ˆä¿è¯æ–°é¡¹åœ¨æœ€åï¼‰
            historySet.add(term);
            // é™åˆ¶æœ€å¤šä¿ç•™ 20 æ¡
            if (historySet.size > 20) {
                const first = historySet.values().next().value;
                historySet.delete(first);
            }
            localStorage.setItem(HISTORY_KEY, JSON.stringify([...historySet]));
            renderHistory();
        }

        // æ¸…ç©ºå†å²
        function clearHistory() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æœç´¢å†å²å—ï¼Ÿ')) {
                historySet.clear();
                localStorage.removeItem(HISTORY_KEY);
                renderHistory();
            }
        }

        // ç»˜å›¾å‡½æ•°ï¼ˆä¸å˜ï¼‰
        function drawGraph(data) {
            const option = {
                tooltip: { formatter: '{b}' },
                animationDurationUpdate: 1000,
                series: [{
                    type: 'graph',
                    layout: 'force',
                    force: { repulsion: 1000, edgeLength: 200, gravity: 0.1 },
                    draggable: true,
                    roam: true,
                    label: { show: true, position: 'right', fontSize: 12 },
                    lineStyle: { color: '#888' },
                    emphasis: { focus: 'adjacency', lineStyle: { width: 3, color: '#1f77b4' } },
                    data: data.nodes,
                    links: data.links.map(link => ({
                        source: link.source,
                        target: link.target,
                        value: link.relation
                    })),
                    edgeLabel: { 
                        show: true, 
                        fontSize: 10,
                        formatter: '{c}'
                    }
                }]
            };
            chart.setOption(option, { replaceMerge: ['series'] });

            // âœ… æ–°å¢ï¼šç›‘å¬åŒå‡»äº‹ä»¶
            chart.off('dblclick'); // é¿å…é‡å¤ç»‘å®š
            chart.on('dblclick', function(params) {
                if (params.dataType === 'node' && params.data && params.data.name) {
                    const nodeName = params.data.name;
                    document.getElementById('query').value = nodeName;
                    search();
                }
            });
        }

        // åŠ è½½å…¨å›¾
        function loadFullGraph() {
            chart.showLoading();
            fetch('/api/graph')
                .then(res => res.json())
                .then(drawGraph)
                .catch(err => {
                    console.error('åŠ è½½å¤±è´¥:', err);
                    alert('âŒ å›¾è°±åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æ˜¯å¦è¿è¡Œ');
                })
                .finally(() => chart.hideLoading());
        }

        // æœç´¢å‡½æ•°ï¼ˆæ–°å¢å†å²è®°å½•ï¼‰
        function search() {
            const q = document.getElementById('query').value.trim();
            if (!q) {
                alert('è¯·è¾“å…¥æŸ¥è¯¢è¯');
                return;
            }
            chart.showLoading();
            fetch(`/api/search?q=${encodeURIComponent(q)}`)
                .then(res => res.json())
                .then(data => {
                    drawGraph(data);
                    addToHistory(q); // âœ… ä¿å­˜åˆ°å†å²
                    document.getElementById('query').value = ''; // âœ… æ¸…ç©ºæœç´¢æ¡†
                })
                .catch(err => {
                    console.error('æœç´¢å¤±è´¥:', err);
                    alert('âŒ æœç´¢å¤±è´¥');
                })
                .finally(() => chart.hideLoading());
        }

        // é¡µé¢åŠ è½½
        window.onload = () => {
            initHistory();
            loadFullGraph();
            startHintRotation(); // âœ… å¯åŠ¨è½®æ’­æç¤º
            document.getElementById('query').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    search();
                }
            });
        };
    </script>
</body>
</html>